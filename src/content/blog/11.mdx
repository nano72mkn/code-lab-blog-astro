---
title: "Next.jsã®ISRã‚’Vercelã‚’ä½¿ã‚ãšã«å®Ÿè£…ã™ã‚‹"
published: true
pubDate: "2021-06-01"
tags: ["nextjs", "npm", "aws"]
emoji: "ğŸ¤”"
---

ä»Šå›ã¯ã€`Next.jsã®ISRã‚’Vercelã‚’ä½¿ã‚ãšã«å®Ÿè£…ã™ã‚‹`ã¨ã„ã†ã“ã¨ã§
Vercel ã‚’ä½¿ãˆã°ä¸€ç™ºã§ã™ãŒ Vercel ã‚’ä½¿ã‚ãªã„ã§å®Ÿè£…ã¯ã§ãã‚‹ã®ã‹ã‚„ã£ã¦ã„ãã¾ã™ã€‚

ã–ã£ã¨èª¿ã¹ãŸæ„Ÿã˜ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ã¯

1. next.js
2. serverless-nextjs
3. AWS CLI

ã§ã—ãŸã€‚
AWS ã¯ã¡ã‚‡ã£ã¨è§¦ã£ãŸã“ã¨ãŒã‚ã‚‹åˆå¿ƒè€…ã§ã™ã€‚  
çµæ§‹é›£æ˜“åº¦é«˜ãã†ã ãªã¨æ€ã„ã¤ã¤ã‚„ã£ã¦ã„ãã¾ã™ã€‚

### å°å…¥ã—ã¦ã„ã

#### next.js ã‚’ init

```
$ npx create-next-app --example with-typescript-eslint-jest with-typescript-eslint-jest-app --use-npm
```

#### Serverless Framwork ã‚’å°å…¥

ã¾ãšã¯ã€`Serverless Framework`ã‚’ install
`global`ã«å…¥ã‚Œã‚‹ã‚ˆã†ã«æ›¸ã„ã¦ã‚ã‚‹ã‘ã©ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å«ã‚ã¦ã¿ãŸã€‚

```
$ npm install -D serverless
```

ç¢ºèª

```
$ npx serverless --version
Framework Core: 2.44.0 (local)
Plugin: 5.2.0
SDK: 4.2.3
Components: 3.11.0
```

#### AWS CLI ã®è¨­å®šã™ã‚‹

æ¬¡ã®å·¥ç¨‹èª¿ã¹ã¦ãŸã‚‰ã€AWS CLI ã®è¨­å®šã„ã‚ã„ã‚ã—ãªãã‚ƒã¿ãŸã„ã ã£ãŸã€‚
ã¨ã‚Šã‚ãˆãšã€AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦è¨­å®šã—ã¦ã¿ã‚‹ï¼ˆã¾ã˜ã§åˆå¿ƒè€…ï¼‰

##### aws configure

`aws configure`ã‚’å®Ÿè¡Œ

```
$ aws configure
AWS Access Key ID [None]:
```

Access Key ã‚’èã‹ã‚ŒãŸã®ã§ã€AWS ã® cli ã«ã¤ã„ã¦èª¿ã¹ã‚‹....

> ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¯ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ ID ã¨ç§˜å¯†ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‹ã‚‰ãªã‚Šã€AWS ã«å¯¾ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç½²åã™ã‚‹ã¨ãã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ãŒãªã„å ´åˆã¯ã€AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã—ã¦ã€ä¸å¿…è¦ãªã‚¿ã‚¹ã‚¯ã§ã¯ã€AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚ä»£ã‚ã‚Šã«ã€ã”è‡ªèº«ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’æŒã¤æ–°ã—ã„ç®¡ç†è€… IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ ã€‚

[ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ ID ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-creds)

ã“ã‚Œã§ã™ã­ã€‚
`IAM`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œã‚ã†ã­ã£ã¦ã“ã¨ã¿ãŸã„ã§ã™ã€‚

##### ãƒãƒªã‚·ãƒ¼ã®ä½œæˆ

ãƒãƒªã‚·ãƒ¼ã®ä½œæˆã§å¿…è¦ãªæ¨©é™ã‚’è¨­å®š.....

å¿…è¦ãªæ¨©é™ã«ã¤ã„ã¦ã¯[AWS Permissions for deployment](https://github.com/serverless-nextjs/serverless-next.js#aws-permissions-for-deployment)ã‚’å‚è€ƒã«ã—ã¦ã„ãã¾ã™

`sqs`ã®æ¨©é™ã¯ ISR ã‚’ä½¿ã†ã¨ãã¯å¿…é ˆãªã®ã§ã€ä»Šå›ã¯è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

##### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ

é©å½“ã«åå‰ã‚’ã¤ã‘ã¦ã€å…ˆã»ã©ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼ã‚’é¸æŠã—ä¿å­˜  
åŸºæœ¬çš„ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§å¿…è¦ãªã‚‚ã®ä»¥å¤–é¸æŠã—ã¾ã—ãŸ

##### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é©å½“ã«æ±ºã‚ã‚‹
2. ã‚¢ã‚¯ã‚»ã‚¹ã®ç¨®é¡ã¯`ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹`
3. `æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸`
4. å…ˆã»ã©ä½œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®š
5. `æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸`
6. ã‚¿ã‚°ã¯ã¤ã‘ãš`æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸`
7. å•é¡Œãªã‘ã‚Œã°`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ`ã‚’æŠ¼ã—ã¦å®Œäº†ã§ã™

ç”Ÿæˆã•ã‚ŒãŸ`Access Key`ã¨`Secret Access Key`ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãŠã„ã¦...

##### å†åº¦`aws configure`ã™ã‚‹

```
$ aws configure
```

`Access Key`ã¨`Secret Access Key`ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€ã‚ã¨ã¯ãƒ‡ãƒ•ã‚©ã®ã¾ã¾ enter  
å¤šåˆ†ã€ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã‚‰èª¿ã¹ãªã•ã„ã¨è¨€ã‚ã‚Œã‚‹ã ã‚ã†ã‘ã©ã€ã¨ã‚Šã‚ãˆãšå‹•ã‹ã—ãŸã„ã£ã¦ãƒ¢ãƒãƒ™ãªã®ã§....

```
$ export AWS_ACCESS_KEY_ID=XXXXXXXXXXXXXXXXXXXX
$ export AWS_SECRET_ACCESS_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

ãã—ã¦ã€export ã‚‚è¨­å®šã—ã¦ã“ã“ã¯å®Œäº†ã§ã™ï¼

#### Serverless Next.js Component ã‚’å°å…¥

`serverless.yaml`ã‚’ä½œæˆã—...

```javascript:serverless.yaml
myApp:
  component: '@sls-next/serverless-component@1.20.0-alpha.4'
```

component ã‚’æŒ‡å®šã™ã‚‹
ä»Šå›ã¯ ISR å¯¾å¿œã—ãŸã„ã®ã§`@sls-next/serverless-component@1.20.0-alpha.4`ã‚’æŒ‡å®š

#### ã„ã£ãŸã‚“ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹

ãªã‚“ã‹ã€`serverless.yaml`ã«`inputs`ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒå¤šã„ã®ã§ã™ãŒã€`Zero-config`ã‚’æ²ã’ã¦ãŸã¨æ€ã†ã®ã§ã„ã‘ã‚‹ã‚“ã˜ã‚ƒãªã„ï¼Ÿã¨ã„ã†æ°—æŒã¡ã§ã‚„ã£ã¡ã‚ƒã„ã¾ã™ã€‚

å¥½å¥‡å¿ƒã ã„ã˜

```
$ npx serverless
```

è‰²ã€…ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œ....

```

  myApp:
    appUrl:         https://********.cloudfront.net
    bucketName:    ********
    distributionId: ********

  ******************************************************************************************************************************************************************
  Warning: You are using the beta version of Serverless Components. Please migrate to the GA version for enhanced features: https://github.com/serverless/components
  ******************************************************************************************************************************************************************


  37s â€º myApp â€º done
```

Warning ã§ã¦ã¾ã™ãŒã€ISR å¯¾å¿œãŒã¾ã ãƒ™ãƒ¼ã‚¿ç‰ˆãªã®ã§ã—ã‹ãŸãªã—ã§ã™ã­ã€‚

#### ISR å¯¾å¿œã—ã¦ç¢ºèªã—ã¦ã„ã

ã¾ãšã¯ã€`test/isr.tsx`ã‚’ä½œæˆ

```typescript:test/isr.tsx
import React from 'react'
import { GetStaticProps } from 'next'

interface Props {
  date: Date
}

export const getStaticProps: GetStaticProps = async () => {
  return {
    props: {
      date: new Date().toLocaleString(),
    },
    revalipubDate: 5,
  }
}

const Isr: React.VFC<Props> = ({ date }) => <p>{date}</p>

export default Isr

```

#### ãƒ‡ãƒ—ãƒ­ã‚¤

```
503 ERROR
The request could not be satisfied.
```

503 ã‚¨ãƒ©ãƒ¼ã§ã¾ã—ãŸã€‚
ãµã¦å¯ã—ãã†ã§ã™ã€‚

ã‚ªãƒ¼ãƒã‚¤ã‚ªãƒ¼ãƒã‚¤...  
è¦‹è½ã¨ã—ã¦ã¾ã—ãŸæ¨©é™ã‚‚ä¿®æ­£ã—ãªã„ã¨ã§ã™ã­  
sqs ã®ã¨ã“ã‚ãŒ`*`ã«ãªã£ã¦ã¾ã™ã­

â†“ å‚è€ƒ

https://github.com/serverless-nextjs/serverless-next.js/pull/1028/files/75862600800bc6d4c22fffbc046e0ad919c8e328#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5

ã‚ªãƒ¼ãƒã‚¤ã‚ªãƒ¼ãƒã‚¤...
ã‚‚ã†ã“ã‚Œã§ã—ãŸã­ã—ã£ã‹ã‚Šã¨å•é¡Œã¨ã—ã¦ä¸ŠãŒã£ã¦ã¾ã™ã­

> Sure, let me take a look at the logs and let you know what happened
> EDIT: looks like the Lambda itself doesn't have permissions to access SQS endpoint:
>
> ```
> {
>     "errorType": "AccessDenied",
>     "errorMessage": "Access to the resource https://sqs.us-east-1.amazonaws.com/ is denied.",
> ....
> ```
>
> I'll fix but we should also make sure to mention in Readme to give the Lambda itself permissions to access SQS (if it > > wasn't obvious or already done)

â†“ å‚è€ƒ

https://github.com/serverless-nextjs/serverless-next.js/pull/1028#issuecomment-840797929

æœ€çµ‚çš„ã«ã€CloudFront / SQS / Lambda ãªã©ãªã©å‰Šé™¤ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®`.serverless`ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰
å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚‰æ­£å¸¸ã«æ¨©é™ãŒé©ç”¨ã•ã‚Œã€å•é¡Œãªãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸï¼

## å‚è€ƒ

ã‚ã£ã¡ã‚ƒå‚è€ƒã«ã•ã›ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸï¼
ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™....!

- [serverless-next.js](https://github.com/serverless-nextjs/serverless-next.js#readme)
- [serverless-nextjs - awspermissions](https://serverless-nextjs.com/docs/awspermissions/)
- [Serverless Nextjs Plugin ã‚’è©¦ã—ã¦ã¿ãŸ](https://dev.classmethod.jp/articles/tried-serverless-nextjst-plugin/)
- [Vercel ã‚’ä½¿ã‚ãšã« AWS ã ã‘ã§ Next.js ã® ISR å¯¾å¿œ!ã€serverless-next.jsã€‘](https://zenn.dev/makumattun/articles/6e260f3a5af117)
- [AWS CLI ã®è¨­å®š](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-configure-quickstart.html)
- [serverless-next.js ã® ISR å¯¾å¿œæ™‚ã® PR](https://github.com/serverless-nextjs/serverless-next.js/pull/1028)
